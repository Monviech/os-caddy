<div style="background-color: white; padding: 10px; border: 1px solid #ddd;">
    <h1 id="formHeadline">
        <!-- Dynamically popualted with Javascript -->    
    </h1>
    {{ partial("layout_partials/base_form", ['fields': reverseProxyForm, 'id': 'frm_ReverseProxy']) }}
    <div id="formErrors" style="color: red;"></div> <!-- Container for general form errors -->
</div>

<div style="margin-top: 20px; width: 100%; background-color: white; padding: 5px; border: 1px solid #ddd;">
    <!-- Save button -->
    <button id="reverseProxySaveAct" class="btn btn-primary" type="button" style="margin-left: 4px;"><b>Save</b></button>
    <!-- Cancel button -->
    <button id="reverseProxyCancelAct" class="btn btn-secondary" type="button" style="margin-left: 4px;"><b>Cancel</b></button>
</div>

<script type="text/javascript">
    // Function to retrieve a parameter from the URL query string
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] === variable) {
                return decodeURIComponent(pair[1].replace(/\+/g, " "));
            }
        }
        return false;
    }

    $(document).ready(function() {
        var uuid = getQueryVariable("uuid");

        if (uuid) {
            $('#formHeadline').text('Edit Reverse Proxy Entry');
            // Fetch and populate data for editing based on UUID
            fetch('/api/caddy/ReverseProxy/get/' + uuid)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    var entry = data.reverse[uuid];
                    if (entry) {
                        $('#caddy\\.reverseproxy\\.reverse\\.Enabled').prop('checked', entry.Enabled === "1");
                        $('#caddy\\.reverseproxy\\.reverse\\.FromDomain').val(entry.FromDomain);
                        $('#caddy\\.reverseproxy\\.reverse\\.FromPort').val(entry.FromPort);
                        $('#caddy\\.reverseproxy\\.reverse\\.ToDomain').val(entry.ToDomain);
                        $('#caddy\\.reverseproxy\\.reverse\\.ToPort').val(entry.ToPort);
                        $('#caddy\\.reverseproxy\\.reverse\\.Description').val(entry.Description);
                    }
                })
                .catch(function(error) {
                    console.error('Error fetching reverse proxy entry:', error);
                });
        } else {
            // No UUID means it's either Add or Clone
            var isClone = window.location.search.indexOf('Enabled') > -1;
            if (isClone) {
                $('#formHeadline').text('Clone Reverse Proxy Entry');
            } else {
                $('#formHeadline').text('Add Reverse Proxy Entry');
            }

            // Common logic for Add and Clone (populate fields if query params exist)
            function populateField(id, value) {
                if (value !== false) {
                    $(id).val(value);
                } else {
                    $(id).val(''); // Clear the field
                }
            }

            populateField('#caddy\\.reverseproxy\\.reverse\\.Enabled', getQueryVariable("Enabled") === "1");
            populateField('#caddy\\.reverseproxy\\.reverse\\.FromDomain', getQueryVariable("FromDomain"));
            populateField('#caddy\\.reverseproxy\\.reverse\\.FromPort', getQueryVariable("FromPort"));
            populateField('#caddy\\.reverseproxy\\.reverse\\.ToDomain', getQueryVariable("ToDomain"));
            populateField('#caddy\\.reverseproxy\\.reverse\\.ToPort', getQueryVariable("ToPort"));
            populateField('#caddy\\.reverseproxy\\.reverse\\.Description', getQueryVariable("Description"));
        }

        // Event listener for the Save button
        $('#reverseProxySaveAct').click(function() {
            var formData = {};

            // Manually collect each field value
            formData['Enabled'] = $('#caddy\\.reverseproxy\\.reverse\\.Enabled').is(':checked') ? "1" : "0";
            formData['FromDomain'] = $('#caddy\\.reverseproxy\\.reverse\\.FromDomain').val();
            formData['FromPort'] = $('#caddy\\.reverseproxy\\.reverse\\.FromPort').val();
            formData['ToDomain'] = $('#caddy\\.reverseproxy\\.reverse\\.ToDomain').val();
            formData['ToPort'] = $('#caddy\\.reverseproxy\\.reverse\\.ToPort').val();
            formData['Description'] = $('#caddy\\.reverseproxy\\.reverse\\.Description').val();

            console.log("Structured Form Data:", formData);

            // Determine the correct API endpoint and method
            var apiEndpoint = '/api/caddy/ReverseProxy/';
            var apiMethod = 'POST';
            var isEdit = uuid !== false;

            if (isEdit) {
                // If editing, use the PUT method and append the UUID to the endpoint
                apiEndpoint += 'set/' + uuid;
                apiMethod = 'PUT';
            } else {
                // If adding, use the POST method and the 'add' endpoint
                apiEndpoint += 'add';
                apiMethod = 'POST';
            }

            // AJAX call to add or edit an entry
            $.ajax({
                url: apiEndpoint,
                method: apiMethod,
                contentType: 'application/json',
                data: JSON.stringify({ reverse: formData }), // This should remain the same for both add and edit
                success: function(data) {
                    console.log("AJAX request successful:", data);
                    $('#formErrors').empty(); // Clear previous errors
                    if (data.status === 'failed') {
                        var errorHtml = '';
                        if (data.errors) {
                            $.each(data.errors, function(key, message) {
                                errorHtml += '<div>' + message + '</div>';
                            });
                        } else {
                            errorHtml = '<div>' + data.message + '</div>';
                        }
                        $('#formErrors').html(errorHtml); // Display errors
                    } else {
                        // Handle success (e.g., clear form, show success message, redirect)
                        window.location.href = '/ui/caddy/reverse_proxy'; // Redirect on success
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX request failed:", error);
                    $('#formErrors').text('An error occurred while saving the entry.');
                }
            });
        });

        // Event listener for the Cancel button
            $('#reverseProxyCancelAct').click(function() {
            window.location.href = '/ui/caddy/reverse_proxy';
        });
    });
</script>

